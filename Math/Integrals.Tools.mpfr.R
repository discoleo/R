

####################

library(Rmpfr)

### Helper Constants
Euler   = mpfr("0.577215664901532860606512090", 144);
Catalan = mpfr("0.915965594177219015054603514", 144);


# Helper: toString for mpfr;
as.valString = function(s, print = TRUE) {
	s = gsub("Â±", "", s);
	s = strsplit(s, "[ *\r\n]+")[[1]];
	s = matrix(s, ncol=2, byrow = TRUE);
	if(print) {
		cat(paste0("\"", s[,1], "\",\n"));
		cat("\n");
		cat(paste0("\"", s[,2], "\",\n"));
	}
	invisible(s);
}

# https://www.advanpix.com/2011/11/07/gauss-kronrod-quadrature-nodes-weights/

# Gauss Nodes:
p10 = c(
	"1.488743389816312108848260011297200e-01",
	"4.333953941292471907992659431657842e-01",
	"6.794095682990244062343273651148736e-01",
	"8.650633666889845107320966884234930e-01",
	"9.739065285171717200779640120844521e-01"
)

# Konrod Nodes:
p21 = c("0.000000000000000000000000000000000e+00",
	"1.488743389816312108848260011297200e-01",
	"2.943928627014601981311266031038656e-01",
	"4.333953941292471907992659431657842e-01",
	"5.627571346686046833390000992726941e-01",
	"6.794095682990244062343273651148736e-01",
	"7.808177265864168970637175783450424e-01",
	"8.650633666889845107320966884234930e-01",
	"9.301574913557082260012071800595083e-01",
	"9.739065285171717200779640120844521e-01",
	"9.956571630258080807355272806890028e-01"
)
p61 = c("0.000000000000000000000000000000000e+00",
 "5.147184255531769583302521316672257e-02",
 "1.028069379667370301470967513180006e-01",
 "1.538699136085835469637946727432559e-01",
 "2.045251166823098914389576710020247e-01",
 "2.546369261678898464398051298178051e-01",
 "3.040732022736250773726771071992566e-01",
 "3.527047255308781134710372070893739e-01",
 "4.004012548303943925354762115426606e-01",
 "4.470337695380891767806099003228540e-01",
 "4.924804678617785749936930612077088e-01",
 "5.366241481420198992641697933110728e-01",
 "5.793452358263616917560249321725405e-01",
 "6.205261829892428611404775564311893e-01",
 "6.600610641266269613700536681492708e-01",
 "6.978504947933157969322923880266401e-01",
 "7.337900624532268047261711313695276e-01",
 "7.677774321048261949179773409745031e-01",
 "7.997278358218390830136689423226832e-01",
 "8.295657623827683974428981197325019e-01",
 "8.572052335460610989586585106589439e-01",
 "8.825605357920526815431164625302256e-01",
 "9.055733076999077985465225589259583e-01",
 "9.262000474292743258793242770804740e-01",
 "9.443744447485599794158313240374391e-01",
 "9.600218649683075122168710255817977e-01",
 "9.731163225011262683746938684237069e-01",
 "9.836681232797472099700325816056628e-01",
 "9.916309968704045948586283661094857e-01",
 "9.968934840746495402716300509186953e-01",
 "9.994844100504906375713258957058108e-01"
)

# Weights:
w10 = c(
	"2.955242247147528701738929946513383e-01",
	"2.692667193099963550912269215694694e-01",
	"2.190863625159820439955349342281632e-01",
	"1.494513491505805931457763396576973e-01",
	"6.667134430868813759356880989333179e-02"
)
w21 = c("1.494455540029169056649364683898212e-01",
	"1.477391049013384913748415159720680e-01",
	"1.427759385770600807970942731387171e-01",
	"1.347092173114733259280540017717068e-01",
	"1.234919762620658510779581098310742e-01",
	"1.093871588022976418992105903258050e-01",
	"9.312545458369760553506546508336634e-02",
	"7.503967481091995276704314091619001e-02",
	"5.475589657435199603138130024458018e-02",
	"3.255816230796472747881897245938976e-02",
	"1.169463886737187427806439606219205e-02"
)
w30 = c("1.028526528935588403412856367054150e-01",
	"1.017623897484055045964289521685540e-01",
	"9.959342058679526706278028210356948e-02",
	"9.636873717464425963946862635180987e-02",
	"9.212252223778612871763270708761877e-02",
	"8.689978720108297980238753071512570e-02",
	"8.075589522942021535469493846052973e-02",
	"7.375597473770520626824385002219073e-02",
	"6.597422988218049512812851511596236e-02",
	"5.749315621761906648172168940205613e-02",
	"4.840267283059405290293814042280752e-02",
	"3.879919256962704959680193644634769e-02",
	"2.878470788332336934971917961129204e-02",
	"1.846646831109095914230213191204727e-02",
	"7.968192496166605615465883474673622e-03"
)
w61 = c("5.149472942945156755834043364709931e-02",
 "5.142612853745902593386287921578126e-02",
 "5.122154784925877217065628260494421e-02",
 "5.088179589874960649229747304980469e-02",
 "5.040592140278234684089308565358503e-02",
 "4.979568342707420635781156937994233e-02",
 "4.905543455502977888752816536723817e-02",
 "4.818586175708712914077949229830459e-02",
 "4.718554656929915394526147818109949e-02",
 "4.605923827100698811627173555937358e-02",
 "4.481480013316266319235555161672324e-02",
 "4.345253970135606931683172811707326e-02",
 "4.196981021516424614714754128596976e-02",
 "4.037453895153595911199527975246811e-02",
 "3.867894562472759295034865153228105e-02",
 "3.688236465182122922391106561713597e-02",
 "3.497933802806002413749967073146788e-02",
 "3.298144705748372603181419101685393e-02",
 "3.090725756238776247288425294309227e-02",
 "2.875404876504129284397878535433421e-02",
 "2.650995488233310161060170933507541e-02",
 "2.419116207808060136568637072523203e-02",
 "2.182803582160919229716748573833899e-02",
 "1.941414119394238117340895105012846e-02",
 "1.692088918905327262757228942032209e-02",
 "1.436972950704580481245143244358001e-02",
 "1.182301525349634174223289885325059e-02",
 "9.273279659517763428441146892024360e-03",
 "6.630703915931292173319826369750168e-03",
 "3.890461127099884051267201844515503e-03",
 "1.389013698677007624551591226759700e-03"
)

####################

# Gauss Nodes:
p10 = mpfr(p10, 114); p21 = mpfr(p21, 114);
w10 = mpfr(w10, 114); w21 = mpfr(w21, 114);
p61 = mpfr(p61, 114);
w61 = mpfr(w61, 114); w30 = mpfr(w30, 114);
#
p10 = c(- p10, p10); p21 = c(- p21[-1], p21);
p61 = c(- p61[-1], p61);
w10 = c(w10, w10); w21 = c(w21[-1], w21);
w30 = c(w30, w30); w61 = c(w61[-1], w61);

#
int.mpfr = function(FUN, low, up, ..., p = p21, w = list(w10, w21)) {
	low = mpfr(low, 114); # theoretically not needed;
	up  = mpfr(up, 114);
	x = (p + 1) / 2;
	x = x * (up - low) + low;
	len = length(w[[1]]);
	id = seq(1, by = 2, length.out = len/2);
	id = c(id, id + len + 1);
	vv = FUN(x, ...);
	v2 = sum(w[[2]] * vv) * (up - low) / 2;
	v1 = sum(w[[1]] * vv[id]) * (up - low) / 2;
	vr = list(value = 0, abs.error = 0,
		message = "OK", subdivisions = 1);
	class(vr) = "integrate.mpfr";
	vr$value = v2; vr$abs.error = abs(v2-v1);
	return(vr);
}


####################
####################

# Example:
f1 = \(x) exp(x^2)
integrate(f1, 0, 1)
int.mpfr(f1, 0, 1)


# Still fails:
FUN = \(x, y) sqrt( y/x * (1-x) / (1 - x*y) );
int.mpfr(\(x) sapplyMpfr(x, \(y) int.mpfr(FUN, 0, 1, y=y)$value), 0, 1)
3 - 2*Catalan;

#
integrate(\(x) as.numeric(sapplyMpfr(x, \(y) int.mpfr(FUN,
	0, 1, y=y, p=p61, w = list(w30, w61))$value)), 0, 1, rel.tol=1E-9)
3 - 2*Catalan;

#
integrate(\(x) as.numeric(sapplyMpfr(x, \(y) int.mpfr(FUN,
	0, 1/4, y=y, p=p61, w = list(w30, w61))$value)), 0, 1, rel.tol=1E-9)$value +
integrate(\(x) as.numeric(sapplyMpfr(x, \(y) int.mpfr(FUN,
	1/4, 1, y=y, p=p61, w = list(w30, w61))$value)), 0, 1, rel.tol=1E-9)$value;
3 - 2*Catalan;

#
integrate(\(x) sapply(x, \(y) integrate(\(x)
	sqrt( y/x * (1-x) / (1 - x*y) ), 0, 1/2, rel.tol=1E-9)$value), 0, 1, rel.tol=1E-9)$value +
integrate(\(x) sapply(x, \(y) integrate(\(x)
	sqrt( y/x * (1-x) / (1 - x*y) ), 1/2, 1, rel.tol=1E-9)$value), 0, 1, rel.tol=1E-9)$value;
3 - 2*Catalan;

